<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.pakmall.mapper.BoardMapper">

<!-- 게시판 리스트 -->
<select id="getBoardList" resultType="com.pakmall.domain.BoardVO" >

<![CDATA[	
SELECT *
	FROM
	(	SELECT ROWNUM rn, a.*
		FROM
		(
			SELECT bd_num, bd_title, bd_content, mem_id, bd_date_reg, mem_pw, bd_parent, bd_ref, bd_layer, bd_show, 
                    (SELECT COUNT(*) FROM BOARD_RE_TBL WHERE bd_num =b.bd_num) AS bd_re_count
                    FROM BOARD_TBL b
			ORDER BY bd_parent DESC, bd_ref ASC
		) a
		WHERE 
		
		]]> 
	<include refid="criteria"></include>
		    
		    
	<![CDATA[
		
		ROWNUM <= #{pageNum} * #{amount}
	) A
WHERE A.rn > (#{pageNum}-1) * #{amount} 

	]]>    
</select>

<select id="getTotalCountList" resultType="int">
	select count(*) from board_tbl where
	
	<include refid="criteria"></include>
	  
	<![CDATA[ 
	bd_num > 0
	]]>
	
</select>

<!-- 게시판 리스트 상세 -->
<select id="board_detail" resultType="com.pakmall.domain.BoardVO">
	SELECT bd_num
			, bd_title
			, bd_content
			, mem_id
			, mem_pw
			, bd_date_reg
			, bd_parent
			, bd_ref
			, bd_layer
			, bd_show
	    FROM BOARD_TBL
	    WHERE bd_num = #{bd_num}
</select>

<!-- 검색기능 -->
<!-- <sql>태그는 include목적으로 사용 -->
<sql id="criteria" >
	<trim prefix="(" suffix=") and" prefixOverrides="OR" >
		<foreach item="type" collection="typeArr">
			<trim prefix="OR" >
				<choose>
					<when test="type == 'T'.toString()" >
						BD_TITLE like '%' || #{keyword} || '%'
					</when>
					<when test="type == 'C'.toString()" >
						BD_CONTENT like '%' || #{keyword} || '%'
					</when>
					<when test="type == 'W'.toString()" >
						MEM_ID like '%' || #{keyword} || '%'
					</when>
				</choose>
			</trim>
		</foreach>
	</trim>
</sql>

<!-- 게시글 쓰기 -->
<insert id="board_register" >
	INSERT INTO BOARD_TBL(BD_NUM, BD_TITLE, BD_CONTENT, MEM_ID, MEM_PW, BD_DATE_REG, BD_PARENT ,BD_REF, BD_LAYER, BD_SHOW)
	VALUES (
		  SEQ_BOARD_TBL.NEXTVAL
		, #{bd_title}
		, #{bd_content}
		, #{mem_id}
		, #{mem_pw}
		, SYSDATE
		, SEQ_BOARD_TBL.NEXTVAL
		, 0
		, 0
		, 'y')
</insert>

<update id="board_update" >
	UPDATE BOARD_TBL
    SET BD_TITLE = #{bd_title}
        , BD_CONTENT = #{bd_content}
        , MEM_ID = #{mem_id}
	WHERE BD_NUM = #{bd_num}
</update>

<update id="board_delete">
	UPDATE board_tbl
	SET bd_show = 'n'
	WHERE BD_NUM = #{bd_num}
</update>
<!-- 
<delete id="board_delete">
	DELETE FROM board_tbl
	WHERE BD_NUM = #{bd_num}
</delete> -->
	
</mapper>